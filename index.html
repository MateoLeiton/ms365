<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Demo Login – Entra External ID</title>

    <style>
        /* resets básicos */
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
          background: #121212;
          color: #e0e0e0;
          height: 100vh;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .container {
          width: 100%;
          max-width: 400px;
          padding: 20px;
        }

        .card {
          background: #1e1e1e;
          border: 1px solid #2a2a2a;
          border-radius: 8px;
          padding: 40px 30px;
          text-align: center;
          box-shadow: 0 4px 12px rgba(0,0,0,0.6);
        }

        h1 {
          margin-bottom: 30px;
          font-size: 24px;
          color: #ffffff;
        }

        .btn {
          width: 100%;
          padding: 12px 0;
          margin: 10px 0;
          border: none;
          border-radius: 4px;
          font-size: 16px;
          cursor: pointer;
          transition: background-color 0.3s, transform 0.2s;
        }

        .btn:hover {
          transform: scale(1.02);
        }

        .btn:active {
          transform: scale(0.98);
        }

        .btn-secondary {
          background: #353535;
          color: #cccccc;
        }

        .btn-secondary:hover {
          background: #3f3f3f;
        }

        .btn {
          background: #0078d4;
          color: #ffffff;
        }

        .btn:hover {
          background: #005a9e;
        }

        .user-info {
          margin-top: 20px;
          font-size: 18px;
          color: #a0a0a0;
        }

        .loading {
          display: none;
          margin-top: 20px;
          color: #a0a0a0;
        }
    </style>

    <script src="https://alcdn.msauth.net/browser/2.32.0/js/msal-browser.min.js"></script>
</head>

<body>
    <div class="container">
        <div class="card">
            <h1>Iniciar Sesión</h1>

            <button id="loginBtn" class="btn">Iniciar sesión</button>
            <button id="logoutBtn" class="btn btn-secondary">Cerrar sesión</button>

            <p id="userInfo" class="user-info"></p>
            <p id="loading" class="loading">Procesando autenticación...</p>
        </div>
    </div>

    <script>
        // CONFIGURACIÓN CORRECTA PARA ENTRA EXTERNAL ID
        const msalConfig = {
            auth: {
                clientId: "ddc5c2cb-1157-4967-bf0a-f8f9b338f9c1",
                // Usando la autoridad correcta para External ID
                authority: "https://8d58f40b-55de-4ac5-9838-498005242b2e.ciamlogin.com/8d58f40b-55de-4ac5-9838-498005242b2e",
                redirectUri: "https://ms365-cyan.vercel.app/",
                knownAuthorities: ["8d58f40b-55de-4ac5-9838-498005242b2e.ciamlogin.com"]
            },
            cache: {
                cacheLocation: "localStorage",
                storeAuthStateInCookie: false
            }
        };

        const msalInstance = new msal.PublicClientApplication(msalConfig);

        const loginBtn = document.getElementById("loginBtn");
        const logoutBtn = document.getElementById("logoutBtn");
        const userInfo = document.getElementById("userInfo");
        const loading = document.getElementById("loading");

        // Inicializar MSAL
        msalInstance.initialize().then(() => {
            console.log("MSAL inicializado correctamente");
            
            // Manejar la respuesta después del redirect
            msalInstance.handleRedirectPromise().then(response => {
                loading.style.display = "none";
                
                if (response) {
                    console.log("Respuesta de autenticación:", response);
                    handleResponse(response);
                } else {
                    // Verificar si ya hay una sesión activa
                    checkAccount();
                }
            }).catch(err => {
                loading.style.display = "none";
                console.error("Error en handleRedirectPromise:", err);
                
                if (err.errorCode) {
                    alert(`Error: ${err.errorCode}\n\n${err.errorMessage}`);
                }
            });
        }).catch(err => {
            console.error("Error al inicializar MSAL:", err);
            loading.style.display = "none";
        });

        // Evento de inicio de sesión - USA REDIRECT EN LUGAR DE POPUP
        loginBtn.onclick = async () => {
            try {
                console.log("Iniciando login con redirect...");
                loading.style.display = "block";
                
                const loginRequest = {
                    scopes: ["openid", "profile", "email"],
                    prompt: "select_account"
                };

                // CAMBIO PRINCIPAL: loginRedirect en lugar de loginPopup
                await msalInstance.loginRedirect(loginRequest);
                
            } catch (err) {
                loading.style.display = "none";
                console.error("Error completo:", err);
                
                if (err.errorCode) {
                    console.error("Código de error:", err.errorCode);
                    console.error("Mensaje:", err.errorMessage);
                    alert(`Error: ${err.errorCode}\n\n${err.errorMessage}`);
                } else {
                    alert("Error al iniciar sesión. Revisa la consola para más detalles.");
                }
            }
        };

        logoutBtn.onclick = async () => {
            try {
                const account = msalInstance.getAllAccounts()[0];

                if (account) {
                    // También usa redirect para el logout
                    const logoutRequest = {
                        account: account,
                        postLogoutRedirectUri: "https://ms365-cyan.vercel.app/"
                    };
                    
                    await msalInstance.logoutRedirect(logoutRequest);
                }
                
            } catch (err) {
                console.error("Error al cerrar sesión:", err);
            }
        };

        function handleResponse(response) {
            if (response && response.account) {
                const account = response.account;
                console.log("Cuenta autenticada:", account);
                
                userInfo.textContent = `Hola, ${account.name || account.username}`;
                loginBtn.style.display = "none";
                logoutBtn.style.display = "inline-block";
            }
        }

        function checkAccount() {
            const currentAccounts = msalInstance.getAllAccounts();
            console.log("Cuentas en caché:", currentAccounts);

            if (currentAccounts.length > 0) {
                const account = currentAccounts[0];
                userInfo.textContent = `Hola, ${account.name || account.username}`;
                loginBtn.style.display = "none";
                logoutBtn.style.display = "inline-block";
            } else {
                loginBtn.style.display = "inline-block";
                logoutBtn.style.display = "none";
            }
        }
    </script>
</body>
</html>
